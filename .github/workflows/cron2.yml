name: Check Expiration Dates

on:
  schedule:
    - cron: "0 0 * * *"  # Ejecuta la acciÃ³n cada dÃ­a a medianoche UTC
  workflow_dispatch:  # Permite ejecuciÃ³n manual

permissions:
  issues: write  # Requerido para crear issues
  contents: read  # Requerido para leer el JSON del repositorio

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ Configurar entorno y clonar repo
        uses: actions/checkout@v4  # Descarga el cÃ³digo para leer el JSON

      - name: ğŸ” Autenticar GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth setup-git
          gh auth status

      - name: ğŸ“… Comprobar clientes con expiraciones prÃ³ximas
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x  # Habilita la depuraciÃ³n (muestra cada comando ejecutado)

          TODAY=$(date -u +%Y-%m-%d)
          echo "Fecha de hoy: $TODAY"

          echo "ğŸ“‚ Contenido del repositorio:"
          ls -l

          if [ ! -f certificates.json ]; then
            echo "âŒ ERROR: No se encontrÃ³ el archivo certificates.json"
            exit 1
          fi

          echo "ğŸ“œ Contenido de certificates.json:"
          cat certificates.json

          customers=$(jq -c '.[]' certificates.json)

          for row in $customers; do
              name=$(echo $row | jq -r '.name')
              expirationDate=$(echo $row | jq -r '.expirationDate')

              echo "ğŸ” Cliente: $name - Expiration Date: $expirationDate"

              if [[ -z "$expirationDate" ]]; then
                  echo "âš ï¸ Expiration date is empty for $name, skipping..."
                  continue
              fi

              if ! date -d "$expirationDate" +%s > /dev/null 2>&1; then
                  echo "âŒ ERROR: Invalid date format for $expirationDate"
                  continue
              fi

              daysLeft=$(( ($(date -d "$expirationDate" +%s) - $(date -d "$TODAY" +%s)) / 86400 ))

              echo "ğŸ“Œ Cliente: $name - Expira en $daysLeft dÃ­as"

              if [ "$daysLeft" -lt 30 ]; then
                  echo "âš ï¸ Expira pronto, verificando si ya existe un issue..."
                  
                  echo "ğŸ”„ Ejecutando 'gh issue list'..."
                  gh issue list --json title --state open --search "$name" > issue_list.json 2>&1

                  echo "ğŸ“‚ Contenido de issue_list.json:"
                  cat issue_list.json

                  if [ ! -s issue_list.json ]; then
                      echo "âŒ ERROR: issue_list.json estÃ¡ vacÃ­o o 'gh issue list' fallÃ³."
                      continue
                  fi

                  issue_titles=$(jq -r '.[].title' issue_list.json)
                  
                  if [ -z "$issue_titles" ]; then
                      echo "âš ï¸ No hay issues con el nombre '$name', creando uno nuevo..."
                      echo "ğŸš€ Creando issue para $name..."
                      gh issue create \
                          --title "âš ï¸ RenovaciÃ³n pendiente para $name" \
                          --body "La suscripciÃ³n de **$name** expira en **$daysLeft dÃ­as** (Fecha de expiraciÃ³n: $expirationDate). Â¡Revisar renovaciÃ³n! ğŸš€" \
                          --repo ${{ github.repository }}
                  else
                      echo "ğŸ¯ Los siguientes issues abiertos tienen el nombre '$name':"
                      echo "$issue_titles"
                      echo "âœ… Ya existe un issue para $name, no se crearÃ¡ otro."
                  fi
              fi
          done