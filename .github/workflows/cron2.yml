name: Check Expiration Dates

on:
  schedule:
    - cron: "0 0 * * *"  # Ejecuta la acci贸n cada d铆a a medianoche UTC
  workflow_dispatch:  # Permite ejecuci贸n manual

permissions:
  issues: write  # Permiso necesario para crear issues

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4  # Descarga el c贸digo para leer el JSON

      - name: Check Expiring Customers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          echo "Fecha de hoy: $TODAY"

          # Leer JSON y filtrar clientes con menos de 30 d铆as hasta la expiraci贸n
          customers=$(jq -c '.[]' certificates.json)
          
          for row in $customers; do
            name=$(echo $row | jq -r '.name')
            expirationDate=$(echo $row | jq -r '.expirationDate')

            # Calcular diferencia de d铆as
            daysLeft=$(( ($(date -d "$expirationDate" +%s) - $(date -d "$TODAY" +%s)) / 86400 ))

            echo "Cliente: $name - Expira en $daysLeft d铆as"

            if [ "$daysLeft" -lt 30 ]; then
              echo "Expira pronto, verificando si ya existe un issue..."

              # Buscar si ya existe un issue abierto con el nombre del cliente
              issue_exists=$(gh issue list --state open --search "$name" --json title | jq -r '.[].title' | grep -c "$name")

              if [ "$issue_exists" -eq 0 ]; then
                echo "Creando issue para $name..."
                gh issue create \
                  --title "锔 Renovaci贸n pendiente para $name" \
                  --body "La suscripci贸n de **$name** expira en **$daysLeft d铆as** (Fecha de expiraci贸n: $expirationDate). 隆Revisar renovaci贸n! " \
                  --repo ${{ github.repository }}
              else
                echo "Ya existe un issue para $name, no se crear谩 otro."
              fi
            fi
          done